####################################################################################################################################################  
#                                                                                                                                                  #
# This file has been generated by Amit Patankar:                                                                                                   #
#     Created by              : amit.patankar                                                                                                      #    
#     Created on              : 17-04-2014                                                                                                         #
#     Directory               : /Progs/Excelerate/Library                                                                                          #
#     Purpose                 : This structure holds the attributes of each Answer Sheet.                                                          #
#                                                                                                                                                  #
####################################################################################################################################################

from Commands import *
from Values import *

#Base Class Analytics Class
class Analytics(object):

    def __init__(self, c):
        self.c = c
        users = list_users_array(self.c)
        self.user_weakpoints_dict = {}  
        self.type_classes = {} 
        self.uw_frequency = []
        self.uw_frequency_dict = {} 
        for username in users:
            filename = user_filename(username, self.c)
            user = load_user(username, filename, c)
            if len(user.tests_taken) != 0:
                uw = User_Weakpoints(user.name)
                for section_type in TYPE_ARRAY:
                    section_stats = user.data.data[section_type]
                    lowest_type_percentage = 100
                    lowest_type = None
                    percent_array = []
                    total = 0
                    for key in section_type_dict(section_type):
                        if section_stats.stats[key].t == 0:
                            continue
                        current_percentage = int(div(section_stats.stats[key].c,section_stats.stats[key].t)*100)
                        if current_percentage <= lowest_type_percentage:
                            lowest_type_percentage = current_percentage
                            lowest_type = key
                        total += current_percentage
                        percent_array.append(current_percentage)
                    if(section_type == WRITING_TYPE):
                        self.uw_frequency.append(WRITING_TYPE_DICT[lowest_type])
                    if(section_type == READING_TYPE):
                        self.uw_frequency.append(READING_TYPE_DICT[lowest_type])
                            
                    if(section_type == MATH_TYPE):
                        self.uw_frequency.append(MATH_TYPE_DICT[lowest_type])

                    average_percent = int(div(total,len(percent_array)))
                    uw.weakpoints[section_type] = (lowest_type, average_percent)

                self.user_weakpoints_dict[user.name] = uw   
       
        for qtype in self.uw_frequency:
            freq = self.uw_frequency.count(qtype)
            if freq > 1:
                for i in range(0,freq):
                    self.uw_frequency.remove(qtype) 
            self.uw_frequency_dict[qtype] = freq  
    
        
    def report(self):
        FILE = open('Users' + DIR_SEP + self.c + DIR_SEP + "analytics" + ".html", "w")
        lines = []

        #HTML opener
        lines.append('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">' + endl)
        lines.append('<html xmlns="http://www.w3.org/1999/xhtml">' + endl)
        lines.append('<head>')
        lines.append('<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />' + endl)
        lines.append('<link rel="stylesheet" type="text/css" href="../../HTML/style.css" />' + endl)
        lines.append('<title>Advanced Score Report</title>' + endl)
        lines.append('</head>' + endl)
        lines.append('<body>' + endl)
        lines.append('<div id="page">' + endl)
        lines.append('<div id="header">' + endl)
        lines.append('<img src="../../HTML/EliteLogo.png" width="35%" alt="Excelerate" />' + endl)
        lines.append('</div>' + endl)
        lines.append('</div>' + endl)
        lines.append('<div id="content">' + endl)
        lines.append('<div id="container">' + endl)
        lines.append('<div id="main">' + endl)
        lines.append('<div id="menu">' + endl)
        lines.append('<h2 style="text-align:center;">Class Analytics Report' + '</h2>' + endl)
        lines.append('</div>' + endl)
        lines.append('<div id="text">' + endl)


        #Class Analysis
        lines.append(endl)
        lines.append("<h1>Overall Student Analysis</h1>" + endl)
        lines.append("<head>")
        lines.append("<style>")
        lines.append("table,th,td{border:1px solid black;border-collapse:collapse;}th,td{padding:5px;}th{text-align:left;}")
        lines.append("</style>")
        lines.append("</head>")

        lines.append('<table style="width:500px">')
        lines.append('<tr><th>Name</th><th>Weakest Math Section</th><th>Weakest Writing Section</th><th>Weakest Reading Section</th></tr>')

        for user in self.user_weakpoints_dict:
            lines.append('<tr>')
            lines.append('<td>' + user + '</td>')
            lines.append('<td>' + MATH_TYPE_DICT[self.user_weakpoints_dict[user].weakpoints[MATH_TYPE][0]] + '</td>')
            lines.append('<td>' + WRITING_TYPE_DICT[self.user_weakpoints_dict[user].weakpoints[WRITING_TYPE][0]] + '</td>')
            lines.append('<td>' + READING_TYPE_DICT[self.user_weakpoints_dict[user].weakpoints[READING_TYPE][0]] + '</td>')
            lines.append('</tr>')


        lines.append('</table>')


        lines.append(endl)

        lines.append("<h1>Class Question Type Weakness</h1>" + endl)
        lines.append('<table style="width:500px">')
        lines.append('<tr><th>Weakest Question Type</th><th>Number Of Students</th></tr>')

        for key in self.uw_frequency_dict:
            lines.append('<tr>')
            lines.append('<td>' + key + '</td>')
            lines.append('<td>' + str(self.uw_frequency_dict[key]) + '</td>')
            lines.append('</tr>')


        lines.append('</table>')

        lines.append(endl)
        lines.append("<h1>Class Writing Questions Missed</h1>" + endl)

        lines.append('<table style="width:500px">')
        lines.append('<tr><th>Section_Question</th><th> Number Of Students Incorrect</th></tr>')
        index = 0
        for q in CLASS_MISSED_WRITING:
            lines.append('<tr>')
            lines.append('<td>' + str(q.question) + '</td>')
            lines.append('<td>' + str(q.frequency) + '</td>')
            index += 1
            if index == 30:
                break
        lines.append('</table>')


        lines.append(endl)
        lines.append("<h1>Class Reading Questions Missed</h1>" + endl)
        lines.append('<table style="width:500px">')
        lines.append('<tr><th>Section_Question</th><th> Number Of Students Incorrect</th></tr>')
        index = 0
        for q in CLASS_MISSED_READING:
            lines.append('<tr>')
            lines.append('<td>' + str(q.question) + '</td>')
            lines.append('<td>' + str(q.frequency) + '</td>')
            index += 1
            if index == 10:
                break
        lines.append('</table>')

        lines.append(endl)
        lines.append("<h1>Class Math Questions Missed</h1>" + endl)
        lines.append('<table style="width:500px">')
        lines.append('<tr><th>Section_Question</th><th> Number Of Students Incorrect</th></tr>')
        index = 0
        for q in CLASS_MISSED_MATH:
            lines.append('<tr>')
            lines.append('<td>' + str(q.question) + '</td>')
            lines.append('<td>' + str(q.frequency) + '</td>')
            index += 1
            if index == 10:
                break
        lines.append('</table>')
        


        #Footer
        lines.append('<br>' + endl)
        lines.append('</div>' + endl)
        lines.append('</div>' + endl)
        lines.append('</div>' + endl)
        lines.append('<div class="clear"></div>' + endl)
        lines.append('<div id="footer">' + endl)
        #lines.append('<p><a>' + 'Class Analytics Report</a></p>' + endl)
        lines.append('<p><img src="../../../HTML/Mini Logo.png" width="8%" alt="Excelerate" /></p>' + endl)
        lines.append('</div>' + endl)
        lines.append('</div>' + endl)


        lines.append('</body>' + endl)
        lines.append('</html>' + endl)
        lines.append(endl)

        FILE.writelines(lines)
        FILE.close()


class User_Weakpoints(object):

    def __init__(self, name):
        self.name = name
        self.weakpoints = {}  
        #value is tuple (weakest question type, average percent for a type)
        self.weakpoints[WRITING_TYPE] = (0,0)
        self.weakpoints[READING_TYPE] = (0,0)
        self.weakpoints[MATH_TYPE] = (0,0)



